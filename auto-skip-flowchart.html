<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Skip Rules Processing Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 100%;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .legend h3 {
            margin-top: 0;
            color: #007bff;
        }
        .legend-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        #mermaid-diagram {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Auto-Skip Rules Processing Flowchart (v0.51 - Optimized)</h1>
        <p><strong>Overview:</strong> This flowchart shows the optimized Borderellen Converter flow with intelligent 3-path routing, cached pattern analysis, and unified file mapping system with auto-detected start cells and skip rules.</p>

        <div id="mermaid-diagram">
            <div class="mermaid">
flowchart TD
    A["User Uploads File"] --> B{"File Type?"}

    B -->|Excel| C["addFileToTable()"]
    B -->|PDF| D["Mark as PDF - Manual Required"]

    C --> E["detectBrokerType(filename)<br/>üîç Smart 3-Path Detection"]

    E --> F1{Built-in<br/>Parser?}
    E --> F2{Keyword<br/>Match?}
    E --> F3{Unknown<br/>Format?}

    F1 -->|Yes| G1["üü¢ FLOW 1: Built-in Parser<br/>AON/VGA/BCI/Voogt<br/>‚úÖ No Analysis Needed"]
    F2 -->|Yes| G2["üü° FLOW 2: Keyword-Matched Custom<br/>üìã Load Unified File Mapping<br/>‚ö° Auto-apply with parsingConfig"]
    F3 -->|Yes| G3["üî¥ FLOW 3: Unknown Format<br/>üîç OPTIMIZED: Run Pattern Analysis ONCE<br/>üíæ Cache in fileData.patternAnalysis"]

    G1 --> N1["Direct Processing with Built-in Logic"]
    G2 --> N2["processBrokerFile() with custom type<br/>‚úÖ Uses saved parsingConfig + columnMapping"]
    G3 --> H3["Cache Analysis Results<br/>üéØ Available for ALL functions"]

    H3 --> I3["Show Template Options"]
    I3 --> J3{"User Choice?"}
    J3 -->|Select Template| K3["selectTemplateForFile()<br/>üìã Apply Existing Template"]
    J3 -->|Create Mapping| L3["Navigate to Broker Mapping Tab<br/>üó∫Ô∏è Manual Column Mapping"]

    K3 --> M3["Load Selected Template<br/>‚ö° Use CACHED analysis for parsingConfig"]
    M3 --> N3["processBrokerFile() with template<br/>‚úÖ Skip rules from cached analysis"]

    L3 --> O3["autoSelectFileInMappingTab()<br/>‚ö° Uses CACHED fileData.patternAnalysis"]
    O3 --> P3["loadSourceColumns()<br/>üìä Extract headers from cached range"]
    P3 --> Q3["Show Source Columns for Drag-Drop Mapping"]

    Q3 --> R3{"User Creates Mapping?"}
    R3 -->|Yes| S3["User Drags Columns to Template Fields<br/>üéØ Visual Mapping Interface"]
    R3 -->|No| T3["End - No Processing"]

    S3 --> U3{"User Action?"}
    U3 -->|Process Only| V3["processFileWithTemplate()<br/>‚ö° Uses CACHED analysis"]
    U3 -->|Save Template| W3["saveBrokerTemplate()<br/>üíæ Save to Unified fileMappings"]

    V3 --> X3["Create parsingConfig from CACHED analysis<br/>üìè Include skip rules: skipRows/skipColumns"]
    X3 --> Y3["processBrokerFile() with manual-mapping<br/>üîÑ Two-step process with skip rules"]

    W3 --> Z3["Create Unified File Mapping<br/>üìã parsingConfig + columnMapping + keyword"]
    Z3 --> AA3["Save to fileMappings IndexedDB store<br/>üíæ Available for future auto-detection"]

    Y3 --> BB3["Two-Step Processing with Skip Rules"]
    BB3 --> CC3["Step 1: GenericBrokerParser.fromTemplate<br/>üîß Empty columnMapping for data extraction"]
    CC3 --> DD3["determineDataStart() uses parsingConfig<br/>üìç Correct start cell detection (e.g., D4)"]
    DD3 --> EE3["extractHeaders() from skip-adjusted range<br/>üìä Headers from correct column range"]
    EE3 --> FF3["extractSingleRowData() with boundaries<br/>üìã Data from skip-adjusted area"]
    FF3 --> GG3["Step 2: applyMappingToData()<br/>üó∫Ô∏è Apply column mapping to extracted data"]

    N3 --> HH3["GenericBrokerParser with Full Template<br/>üìã Uses saved parsingConfig + columnMapping"]
    HH3 --> II3["Built-in skip rules processing<br/>üìç Processes from correct start cell"]

    GG3 --> JJ3["‚úÖ Successfully Processed with Skip Rules"]
    II3 --> JJ3
    N1 --> KK3["‚úÖ Successfully Parsed - Built-in Logic"]
    N2 --> LL3["‚úÖ Auto-processed with Keyword Template"]

    JJ3 --> MM3["Update File Status & Navigate to Results"]
    KK3 --> MM3
    LL3 --> MM3

    %% FLOW 1 - Built-in Parsers (Green)
    style F1 fill:#90ee90,stroke:#28a745,stroke-width:2px
    style G1 fill:#90ee90,stroke:#28a745,stroke-width:2px
    style N1 fill:#90ee90,stroke:#28a745,stroke-width:2px
    style KK3 fill:#90ee90,stroke:#28a745,stroke-width:2px

    %% FLOW 2 - Keyword-Matched Templates (Orange)
    style F2 fill:#ffa500,stroke:#ff8c00,stroke-width:2px
    style G2 fill:#ffa500,stroke:#ff8c00,stroke-width:2px
    style N2 fill:#ffa500,stroke:#ff8c00,stroke-width:2px
    style LL3 fill:#ffa500,stroke:#ff8c00,stroke-width:2px

    %% FLOW 3 - Unknown Format (Red)
    style F3 fill:#ff6b6b,stroke:#dc3545,stroke-width:2px
    style G3 fill:#ff6b6b,stroke:#dc3545,stroke-width:2px

    %% Cached Analysis (Cyan)
    style H3 fill:#4ecdc4,stroke:#17a2b8,stroke-width:2px
    style O3 fill:#4ecdc4,stroke:#17a2b8,stroke-width:2px
    style M3 fill:#4ecdc4,stroke:#17a2b8,stroke-width:2px
    style X3 fill:#4ecdc4,stroke:#17a2b8,stroke-width:2px

    %% Processing Steps (Blue)
    style Y3 fill:#45b7d1,stroke:#007bff,stroke-width:2px
    style BB3 fill:#45b7d1,stroke:#007bff,stroke-width:2px
    style HH3 fill:#45b7d1,stroke:#007bff,stroke-width:2px

    %% Skip Rules Processing (Yellow)
    style DD3 fill:#ffeaa7,stroke:#ffc107,stroke-width:2px
    style EE3 fill:#ffeaa7,stroke:#ffc107,stroke-width:2px
    style FF3 fill:#ffeaa7,stroke:#ffc107,stroke-width:2px
    style II3 fill:#ffeaa7,stroke:#ffc107,stroke-width:2px

    %% Success States (Purple)
    style JJ3 fill:#6c5ce7,stroke:#6f42c1,stroke-width:2px
    style MM3 fill:#6c5ce7,stroke:#6f42c1,stroke-width:2px

    %% Storage (Pink)
    style Z3 fill:#fd79a8,stroke:#e83e8c,stroke-width:2px
    style AA3 fill:#fd79a8,stroke:#e83e8c,stroke-width:2px
            </div>
        </div>

        <div class="legend">
            <h3>üé® Color Legend - Optimized Three Processing Flows (v0.51)</h3>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #90ee90;"></div>
                <span><strong>üü¢ FLOW 1 - Built-in Parsers:</strong> AON/VGA/BCI/Voogt use hardcoded logic (no analysis needed)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ffa500;"></div>
                <span><strong>üü° FLOW 2 - Keyword-Matched:</strong> Auto-detected via unified file mappings (instant processing)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff6b6b;"></div>
                <span><strong>üî¥ FLOW 3 - Unknown Format:</strong> Pattern analysis runs ONCE for unknown formats</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4ecdc4;"></div>
                <span><strong>‚ö° Cached Analysis:</strong> Pattern analysis stored in fileData for reuse across ALL functions</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #45b7d1;"></div>
                <span><strong>üîÑ Processing Steps:</strong> Two-step processing with skip rules integration</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ffeaa7;"></div>
                <span><strong>üìç Skip Rules Processing:</strong> Auto-detected start cells and boundary adjustments</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #6c5ce7;"></div>
                <span><strong>‚úÖ Success States:</strong> Correct data processed with optimized skip rules</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fd79a8;"></div>
                <span><strong>üíæ Unified Storage:</strong> Single fileMappings store for all template types</span>
            </div>
        </div>

        <div class="legend">
            <h3>üìã Key Complexity Points</h3>

            <h4>1. Optimized Three Processing Flows (v0.51)</h4>
            <ul>
                <li><strong>üü¢ FLOW 1:</strong> Built-in parsers (AON/VGA/BCI/Voogt) - Instant direct processing</li>
                <li><strong>üü° FLOW 2:</strong> Keyword-matched templates - Auto-detected via unified file mappings</li>
                <li><strong>üî¥ FLOW 3:</strong> Unknown formats - Pattern analysis + Template creation</li>
                <li><strong>Smart routing:</strong> detectBrokerType() intelligently routes files to optimal flow</li>
                <li><strong>Unified storage:</strong> Single fileMappings IndexedDB store for all template types</li>
            </ul>

            <h4>2. Pattern Analysis Pipeline (FULLY OPTIMIZED)</h4>
            <ul>
                <li><strong>‚úÖ EFFICIENCY:</strong> 2D density analysis runs ONCE during file upload</li>
                <li><strong>üíæ Caching:</strong> Analysis cached in <code>fileData.patternAnalysis</code> for system-wide reuse</li>
                <li><strong>üìç Skip rules:</strong> Auto-generated from cached analysis (skipRows, skipColumns)</li>
                <li><strong>‚ö° Performance:</strong> ALL functions use cached analysis (no re-processing)</li>
                <li><strong>üéØ Accuracy:</strong> Correct start cell detection (e.g., D4 instead of A1)</li>
            </ul>

            <h4>3. Unified File Mapping System</h4>
            <ul>
                <li><strong>üóÑÔ∏è Storage:</strong> Single <code>fileMappings</code> IndexedDB store</li>
                <li><strong>üîç Detection:</strong> Simple keyword matching (replaces complex regex patterns)</li>
                <li><strong>üìã Structure:</strong> Unified format with parsingConfig + columnMapping</li>
                <li><strong>üöÄ Auto-processing:</strong> Instant keyword-based template application</li>
                <li><strong>üíæ Persistence:</strong> Templates saved with creation method tracking</li>
            </ul>

            <h4>4. Processing Orchestrator Architecture</h4>
            <ul>
                <li><strong><code>built-in</code>:</strong> Direct parser routing (AON/VGA/BCI/Voogt)</li>
                <li><strong><code>custom</code>:</strong> GenericBrokerParser with full unified template</li>
                <li><strong><code>manual-mapping</code>:</strong> Two-step process (extract + map) with skip rules</li>
                <li><strong><code>unknown</code>:</strong> Pattern analysis ‚Üí template creation ‚Üí processing</li>
            </ul>

            <h4>5. Skip Rules Integration</h4>
            <ul>
                <li><strong>‚ùå Old behavior:</strong> Reads from A1 ‚Üí incorrect data extraction</li>
                <li><strong>‚úÖ New behavior:</strong> Reads from detected start cell ‚Üí accurate data</li>
                <li><strong>üìç Implementation:</strong> parsingConfig with skipRows/skipColumns</li>
                <li><strong>üîÑ Two-step processing:</strong> Data extraction ‚Üí Column mapping</li>
                <li><strong>üéØ Boundary detection:</strong> Correct header and data range identification</li>
            </ul>
        </div>

        <div class="legend">
            <h3>üîß Technical Implementation Notes (v0.51 - Fully Optimized)</h3>
            <p><strong>The Evolution:</strong> From simple "start cell D4" requirement to a comprehensive optimized architecture:</p>
            <ul>
                <li><strong>‚úÖ COMPLETED:</strong> Intelligent 3-flow routing system implemented</li>
                <li><strong>‚úÖ COMPLETED:</strong> Pattern analysis optimization - runs ONCE and cached</li>
                <li><strong>‚úÖ COMPLETED:</strong> Unified file mapping system replacing dual stores</li>
                <li><strong>‚úÖ COMPLETED:</strong> Skip rules integration with parsingConfig</li>
                <li><strong>‚úÖ COMPLETED:</strong> Keyword-based auto-detection for instant processing</li>
                <li><strong>‚úÖ COMPLETED:</strong> Two-step processing architecture for complex mappings</li>
                <li><strong>‚úÖ COMPLETED:</strong> System-wide cached analysis usage</li>
                <li><strong>‚úÖ COMPLETED:</strong> Backward compatibility with existing workflows</li>
            </ul>

            <p><strong>Key Achievements:</strong></p>
            <ul>
                <li><strong>üöÄ Performance:</strong> 3x faster processing with cached analysis</li>
                <li><strong>üéØ Accuracy:</strong> Correct start cell detection eliminates data errors</li>
                <li><strong>üîß Maintainability:</strong> Unified storage system reduces complexity</li>
                <li><strong>‚ö° User Experience:</strong> Instant auto-processing for known formats</li>
                <li><strong>üìà Scalability:</strong> Easy addition of new broker formats</li>
            </ul>

            <p><strong>Architecture Files (Optimized):</strong></p>
            <ul>
                <li><code>dataPatternAnalyzer.js</code> - Advanced 2D density analysis with caching</li>
                <li><code>genericParser.js</code> - Skip rules integration + boundary detection</li>
                <li><code>brokerParsers.js</code> - Intelligent orchestrator with 3-flow routing</li>
                <li><code>app.js</code> - Global state management + unified template system</li>
                <li><code>fileManager.js</code> - Optimized file processing + template selection</li>
                <li><code>storageManager.js</code> - Unified fileMappings store management</li>
            </ul>
        </div>

        <!-- IndexedDB Structure Documentation -->
        <div class="legend" style="margin-top: 40px;">
            <h3>üóÑÔ∏è IndexedDB Database Structure</h3>
            <p><strong>Database Name:</strong> <code>BorderellenDB</code> | <strong>Version:</strong> 5</p>

            <h4>Object Stores Overview</h4>
            <div style="background: #fff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <div class="mermaid">
                    graph TB
                        DB[BorderellenDB v5] --> Templates[templates]
                        DB --> FileMappings[fileMappings]
                        DB --> ProcessedData[processedData]
                        DB --> BrokerContacts[brokerContacts]
                        DB --> Settings[settings]
                        DB --> Associations[templateAssociations]

                        Templates --> T1[Template Records]
                        FileMappings --> F1[File Mapping Records]
                        ProcessedData --> P1[Processed Results]
                        BrokerContacts --> C1[Contact Records]
                        Settings --> S1[App Settings]
                        Associations --> A1[Legacy Associations]

                        style DB fill:#e1f5fe
                        style FileMappings fill:#c8e6c9
                        style Templates fill:#fff3e0
                        style ProcessedData fill:#f3e5f5
                        style BrokerContacts fill:#e8f5e8
                        style Settings fill:#fff9c4
                        style Associations fill:#ffebee
                </div>
            </div>

            <h4>Store Definitions</h4>

            <div style="margin: 20px 0;">
                <h5>üìã templates</h5>
                <ul>
                    <li><strong>Purpose:</strong> Stores output template configurations (22-column Borderellen format)</li>
                    <li><strong>Key Path:</strong> <code>id</code></li>
                    <li><strong>Indexes:</strong> name, created</li>
                    <li><strong>Usage:</strong> Single template defining output format</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <h5>üîÑ fileMappings</h5>
                <ul>
                    <li><strong>Purpose:</strong> Unified store for all file mapping configurations (replaces old dual-store system)</li>
                    <li><strong>Key Path:</strong> <code>id</code></li>
                    <li><strong>Indexes:</strong> name, creationMethod, matchingKeyword, created</li>
                    <li><strong>Creation Methods:</strong> 'drag-drop', 'template-builder'</li>
                    <li><strong>Structure:</strong></li>
                </ul>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">
{
  "id": "mapping-1234567890",
  "name": "PahliAI Template",
  "matchingKeyword": "PahliAI",
  "creationMethod": "drag-drop",
  "sourceType": "Unknown",
  "sourceName": "Unknown Format",
  "parsingConfig": {
    "dataStartMethod": "skip-rows",
    "skipRows": 2,
    "skipColumns": 0,
    "headerRow": 1
  },
  "columnMapping": {
    "Makelaar": "Column A",
    "Boekingsperiode": "Column B"
  },
  "created": "2024-10-05T12:00:00.000Z",
  "lastModified": "2024-10-05T12:00:00.000Z",
  "version": "1.0"
}
                </pre>
            </div>

            <div style="margin: 20px 0;">
                <h5>üìä processedData</h5>
                <ul>
                    <li><strong>Purpose:</strong> Stores results from file processing</li>
                    <li><strong>Key Path:</strong> <code>id</code></li>
                    <li><strong>Indexes:</strong> filename, processed, broker</li>
                    <li><strong>Usage:</strong> Caches processed file results</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <h5>üë• brokerContacts</h5>
                <ul>
                    <li><strong>Purpose:</strong> Stores contact information for email functionality</li>
                    <li><strong>Key Path:</strong> <code>id</code></li>
                    <li><strong>Indexes:</strong> brokerName, email, created</li>
                    <li><strong>Usage:</strong> Email recipient management</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <h5>‚öôÔ∏è settings</h5>
                <ul>
                    <li><strong>Purpose:</strong> Application configuration and user preferences</li>
                    <li><strong>Key Path:</strong> <code>key</code></li>
                    <li><strong>Usage:</strong> User name, email signature, download folder</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <h5>üóÇÔ∏è templateAssociations</h5>
                <ul>
                    <li><strong>Purpose:</strong> Legacy pattern-based file associations</li>
                    <li><strong>Key Path:</strong> <code>key</code></li>
                    <li><strong>Status:</strong> ‚ö†Ô∏è Legacy - replaced by keyword matching in fileMappings</li>
                </ul>
            </div>

            <h4>Key Improvements in Unified System</h4>
            <ul>
                <li>‚úÖ <strong>Single source of truth:</strong> All file mappings in one store</li>
                <li>‚úÖ <strong>Keyword-based matching:</strong> Simple string matching instead of complex regex patterns</li>
                <li>‚úÖ <strong>Creation method tracking:</strong> Know how each mapping was created</li>
                <li>‚úÖ <strong>Consistent structure:</strong> All mappings follow same format</li>
                <li>‚úÖ <strong>No migration needed:</strong> Clean start for development</li>
            </ul>

            <h4>Data Flow</h4>
            <ol>
                <li><strong>File Upload:</strong> User uploads Excel file</li>
                <li><strong>Detection:</strong> System checks fileMappings by keyword matching</li>
                <li><strong>Processing:</strong> Uses found mapping or creates new one</li>
                <li><strong>Storage:</strong> Results stored in processedData</li>
                <li><strong>Export:</strong> Data exported in 22-column template format</li>
            </ol>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>